[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg)](http://standardjs.com)

```
             _                                   _  _     
          __| | _  _  _ _   __ _  _ __   ___  __| || |__  
         / _` || || || ' \ / _` || '  \ / _ \/ _` || '_ \
         \__,_| \_, ||_||_|\__,_||_|_|_|\___/\__,_||_.__/
                |__/  _                                                     
                  ___| |_  _ _  ___  __ _  _ __  
                 (_-<|  _|| '_|/ -_)/ _` || '  \ 
                 /__/ \__||_|  \___|\__,_||_|_|_|
           _            _    _                              _    
      ___ | | __ _  ___| |_ (_) __  ___ ___  __ _  _ _  __ | |_  
     / -_)| |/ _` |(_-<|  _|| |/ _|(_-</ -_)/ _` || '_|/ _|| ' \ 
     \___||_|\__,_|/__/ \__||_|\__|/__/\___|\__,_||_|  \__||_||_|
                                                             
                                                                            
```
# DynamoDB --> Stream --> ElasticSearch

The missing blueprint for AWS Lambda, which reads stream from AWS DynamoDB and writes it to ElasticSearch.
Compatible with node 8.10. (If for some reason you want to use it with node 6.10, then use 1.0.0 of this module)

Whenever data is changed (modified, removed or inserted) in DynamoDB one can use AWS Lambda function to capture this change and update ElasticSearch machine immediately. Further reading:

[Indexing Amazon DynamoDB Content with Amazon Elasticsearch Service Using AWS Lambda](https://aws.amazon.com/blogs/compute/indexing-amazon-dynamodb-content-with-amazon-elasticsearch-service-using-aws-lambda/) 
## Getting Started

Install:
```javascript
npm i dynamodb-stream-elasticsearch 
```
Use it in your lambda:
```javascript
const { pushStream } = require('dynamodb-stream-elasticsearch');

const { ES_ENDPOINT, INDEX, TYPE, REFRESH } = process.env;

function myHandler(event, context, callback) {
  console.log('Received event:', JSON.stringify(event, null, 2));
  
  pushStream({ 
      event, 
      index: INDEX, // Optional - fallbacks to the table name of your dynamo instance
      type: TYPE, // Optional - fallbacks to index and if that dosnâ€™t exist the table name of your dynamo instance
      refresh: REFRESH, // Optional - Defaults to true
      endpoint: ES_ENDPOINT })
    .then(() => {
      callback(null, `Successfully processed ${event.Records.length} records.`);
    })
    .catch((e) => {
      callback(`Error ${e}`, null);
    });
}

exports.handler = myHandler;
```
Upload Lambda to AWS and _star_ this repository if it works as expected!!

### Parameters

| Param  | Description | Options |
| ------------- | ------------- | ------------- |
| event | Event object generated by the stream (pass it as it is)  | Parse on from the event handler
| index  | The name of ElasticSearch index  | [Optional] fallbacks to the table name of your dynamo instance
| type  | The type of the ElasticSearch document   | [Optional] fallbacks to index and if that dosn't exist the table name of your dynamo instance
| refresh  | Refresh the shard containing the document before performing the operation   | Default: `true`
| endpoint  | Exact url of ElasticSearch instance (it works with AWS ES and standard ES)  | Must have


## Contributing and running the tests

To run tests locally you need to have ElasticSearch docker container. Simply type:

```bash
docker run -i -p 9200:9200 --name my_elastic -p 9300:9300 -e "discovery.type=single-node" elasticsearch
```
If you want to commit changes, make sure if follow these rules:
1. All code changes should go with a proper integration test;
2. Code should follow [Javascript Standard Guideline](https://standardjs.com/);
3. Commit messages should be set according to [this article](https://chris.beams.io/posts/git-commit/).

#### TODO
- Introduce Continuous Integration;
- Add elastic search bulk operation instead of index for multiple records; 

## Authors & Contributors

* [matrus2](https://github.com/matrus2)

## License

This project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details

